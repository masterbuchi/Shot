<!doctype html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <title> Version Alpha Gegnerklasse 0.3 </title>
    <script src="js/phaser.js"></script>
    <script src="js/Message.js"></script>
    <script src="js/Weapon.js"></script>
    <script src="js/Ammo.js"></script>
    <script src="js/Bullet.js"></script>
    <script src="js/Gegner.js"></script>
    <script src="js/Player.js"></script>
    <script src="js/preload.js"></script>

    <style type="text/css">
        body {
            display: inline-block;
            text-align: center;
            margin: 0 auto;
            background-color: darkblue;
        }

        html {
            text-align: center;
        }
    </style>
</head>

<body>

    <script type="text/javascript">
        var game = new Phaser.Game(1024, 768, Phaser.AUTO, '', {
            preload: preload,
            create: create,
            update: update
        });
        // Coole Variable
        var SchussPassiertjetzt = 0;
        // Spielelemente
        var platforms;
        // Musik
        var music;

        // Menuinformationen
        var ausgeruesteterWaffenText;
        var munitionsText;
        // Steuerungsvariablen
        var spaceKey;
        var wKey;
        var aKey;
        var sKey;
        var dKey;




        var child_waffe;


        var player;

        // Waffen
        var munition;
        // Schussarten
        var akSchuss;
        var shotgunSchuss;
        var pistolenSchuss;
        // Waffe aufgenommen
        var sgAufgenommen;
        var rwAufgenommen;
        var akAufgenommen;
        var pistoleAufgenommen;
        // Raketenwerfer
        var raketenexplosion;

        //Gegnergruppen
        var GegnerGruppe;
        var starkeGegnerGruppe;
        var alleGegnerGruppe;

        var Leben = 0;
        var gegnerZahl = 0;
        var gegnerBesiegt = 0;
        //Animationsvariablen
        var richtung = 0;
        var aktiv = false;
        var gegneraktiv = false;
        let gegner;

        var background;
        let weltbreite = 2000;
        let welthöhe = 2000;

        function create() {
            game.physics.startSystem(Phaser.Physics.ARCADE);
            // Welt vergrößern
            game.world.setBounds(0, 0, weltbreite, welthöhe);

            // Musik
            // this.music = game.add.audio('music');
            // this.music.play();

            // Hintergrund
            background = game.add.tileSprite(0, 0, 2000, 2000, 'background');

            // Plattformen
            platforms = game.add.group();
            platforms.enableBody = true;
            ledge = platforms.create(400, game.world.height - 200, 'platform');
            ledge2 = platforms.create(150, 100, 'platform');
            ledge.body.immovable = true;
            ledge2.body.immovable = true;
            // Boden
            ground = platforms.create(0, game.world.height - 1, 'ground');
            ground.scale.setTo(2, 2);
            ground.body.immovable = true;


            // var myGroup = game.add.group();
            // myGroup.classType = MyAwesomeSprite;
            // myGroup.createMultiple(20);

            SpielerGruppe = game.add.group();

            SpielerGruppe.add(new Player(this.game));
            player = SpielerGruppe.getFirstExists(false);
            player.spawn(500, game.world.height - 325, 'keine');

            // Gruppen der Gegner
            GegnerGruppe = game.add.group();

            //Gegner werden erzeugt
            for (let i = 0; i < 10; i++) {
                GegnerGruppe.add(new Gegner(this.game, player));
            }


            gegner = GegnerGruppe.getFirstExists(false);
            gegner.spawn(900, (game.world.height - 222), "starkerGegner", 'right', 'pistol_walk');

            gegner = GegnerGruppe.getFirstExists(false);
            gegner.spawn(300, (game.world.height - 122), "starkerGegner", 'stand_left', 'pistol_stand');

            gegner = GegnerGruppe.getFirstExists(false);
            gegner.spawn(500, (game.world.height - 500), "schwacherGegner", 'left', 'shotgun_walk');

            gegner = GegnerGruppe.getFirstExists(false);
            gegner.spawn(600, (game.world.height - 122), "schwacherGegner", 'kneel_left', 'pistol_kneel');


            // // Starke Gegner werden gruppiert
            starkeGegnerGruppe = game.add.group();
            // starkeGegnerGruppe.add(starkerGegner);


            alleGegnerGruppe = game.add.group();
            // AlleGegnerGruppe.add(schwacherGegner);
            // AlleGegnerGruppe.add(schwacherGegner2);
            // AlleGegnerGruppe.add(starkerGegner);



            // Waffen
            // ak47
            test = new Weapon(30, 400, 'ak', 200, 0.1);
            ak = test.getWeapon();
            // Ak - Projektil kriegt Eigenschaften
            test = new Ammo(6, 'akSchuss', 500, 60, 30, 30, 0);
            akSchuss_alt = test.getSchuss();
            console.log(akSchuss_alt);
            akSchuss = new Bullet(this.game, 6, 'akSchuss', 500, 60, 30, 30, 0, player);
            console.log(akSchuss);
            // Pistole
            test = new Weapon(300, 200, 'pistole', 200, 0.1);
            pistole = test.getWeapon();
            // Pistolen - Projektil kriegt Eigenschaften
            pistolenSchuss = new Bullet(this.game,12, 'pistolenSchuss', 500, 1000, 12, 30, 0, player);
            // Raketenwerfer
            test = new Weapon(400, 400, 'raketenwerfer', 200, 0.1);
            rw = test.getWeapon();
            // Raketenwerfer - Projektil kriegt Eigenschaften
            rakete = new Bullet(this.game, 5, 'rakete', 200, 200, 1, 30, 0, player);
            // Shotgun
            test = new Weapon(5, 30, 'shotgun', 200, 0.1);
            sg = test.getWeapon();
            // Shotgun - Projektil kriegt Eigenschaften
            shotgunSchuss = new Bullet(this.game,25, 'shotgunSchuss', 500, 500, 25, 30, 0, player);
            shotgunSchuss.multiFire = true;
            shotgunSchuss.bulletAngleVariance = 7;


            // Waffen
            waffen = game.add.group();
            waffen.add(pistole);
            waffen.add(ak);
            waffen.add(rw);
            waffen.add(sg);

            // Einfache Projektile
            einfacheProjektile = game.add.group();
            einfacheProjektile.add(akSchuss.bullets);
            einfacheProjektile.add(shotgunSchuss.bullets);
            einfacheProjektile.add(pistolenSchuss.bullets);
            


            // Munitions Text
            munitionsText = game.add.text(16, 112, '', {
                fontSize: '32px',
                fill: '#000'
            });
            munitionsText.fixedToCamera = true;

            // Waffe ausgerüstet
            ausgeruesteterWaffenText = game.add.text(16, 64, '', {
                fontSize: '32px',
                fill: '#000'
            });
            ausgeruesteterWaffenText.fixedToCamera = true;

            // Startanimationen
            // GegnerGruppe.callAllExists('bewegung', true, 'left');
            //console.log(GegnerGruppe.callAllExists('bewegung', true, 'left'))


            // Kamera
            game.camera.follow(player);
        }

        function update() {


            // // schwachen Gegner mit Shotgun treffen
            // game.physics.arcade.overlap(shotgunSchuss.bullets, GegnerGruppe, schwachenGegnerMitShotgunTreffen, null,
            //     this);
            // // starken Gegner mit Shotgun treffen
            // game.physics.arcade.overlap(shotgunSchuss.bullets, starkeGegnerGruppe, starkenGegnerMitShotgunTreffen, null,
            //     this);
            // // schwachen Gegner mit Ak treffen
            // game.physics.arcade.overlap(akSchuss.bullets, GegnerGruppe, schwachenGegnerMitAkTreffen, null, this);
            // // starken Gegner mit Ak treffen
            // game.physics.arcade.overlap(akSchuss.bullets, starkeGegnerGruppe, starkenGegnerMitAkTreffen, null, this);
            // // schwachen Gegner mit Pistole treffen
            // game.physics.arcade.overlap(pistolenSchuss.bullets, GegnerGruppe, schwachenGegnerMitPistoleTreffen, null,
            //     this);
            // // starken Gegner mit Pistole treffen
            // game.physics.arcade.overlap(pistolenSchuss.bullets, starkeGegnerGruppe, starkenGegnermitPistoleTreffen, null,
            //     this);
            // // schwachen Gegner mit Raketenwerfer treffen
            // game.physics.arcade.overlap(raketenexplosion, GegnerGruppe, schwachenGegnerMitRaketenwerferTreffen, null,
            //     this);
            // // starken Gegner mit Raketenwerfen treffen
            // game.physics.arcade.overlap(raketenexplosion, starkeGegnerGruppe, starkenGegnerMitRaketenwerferTreffen, null,
            //     this);


            // Wenn der Spieler einen Gegner berührt erscheint der GameOver Screen.
            game.physics.arcade.overlap(alleGegnerGruppe, player, gameOver, null, this);


            // Kolissionverwaltung von Waffen, Gegnern, Plattformen & Projektile
            game.physics.arcade.collide(waffen, waffen);
            game.physics.arcade.collide(waffen, GegnerGruppe);
            game.physics.arcade.collide(waffen, platforms);
            game.physics.arcade.collide(GegnerGruppe, platforms);
            game.physics.arcade.collide(player, platforms);

            // Waffen aufnehmen
            game.physics.arcade.overlap(player, ak, nimmak, null, this);
            game.physics.arcade.overlap(player, sg, nimmSg, null, this);
            game.physics.arcade.overlap(player, pistole, nimmPistole, null, this);
            game.physics.arcade.overlap(player, rw, nimmRw, null, this);
            // Projektile treffen Plattformen
            game.physics.arcade.overlap(einfacheProjektile, platforms, killSimpleProjectiles, null, this);
            if (raketenexplosion == null) {
                // Projektilwaffen, die ein Projektil abschiessen dass anschließend explodiert
                game.physics.arcade.overlap(rakete.bullets, platforms, raketeExplodiert, null, this);
                //Kollision Rakete mit Gegner
                game.physics.arcade.overlap(rakete.bullets, GegnerGruppe, raketeExplodiert, null, this);
                game.physics.arcade.overlap(rakete.bullets, starkeGegnerGruppe, raketeExplodiert, null, this);
            }
            // RaketenExplosion anhalten oder stoppen
            if (raketenexplosion != null) {
                if (game.physics.arcade.isPaused == true) {
                    explosionTween.pause();
                } else {
                    explosionTween.resume()
                }
                explosionTween.onComplete.addOnce(function () {
                    raketenexplosion.kill();
                }, this);
            }
            //Kollision Raketenexplosion mit Gegner
            game.physics.arcade.overlap(GegnerGruppe, raketenexplosion, schwachenGegnerMitRaketenwerferTreffen,
                null,
                this);
            game.physics.arcade.overlap(starkeGegnerGruppe, raketenexplosion, starkenGegnerMitRaketenwerferTreffen,
                null,
                this);
            //Kollision Raketenexplosion mit Player
            game.physics.arcade.overlap(player, raketenexplosion, gameOver, null, this);


            // NPC-Bwegungen
            //Schwacher Gegner
            if (game.physics.arcade.isPaused == false) {
                if (gegneraktiv == false) {
                    // GegnerGruppe.animations.paused = false;
                    gegneraktiv = true;
                }
            }
        // --- Schießen ---
        // Mithilfe der Maustaste kann der Spieler (wenn er eine Schusswaffe besitzt) schießen.
        if (game.input.activePointer.isDown) {
            // Waffen werden erfolgreich gewechselt.
            if (akAufgenommen == 1) {
                fireAk();
            } else if (rwAufgenommen == 1) {
                fireRaketenwerfer();
            } else if (sgAufgenommen == 1) {
                fireShotgun();
            } else if (pistoleAufgenommen == 1) {
                firePistol();
            }
        }

            
        }
        // Funktionen


        function fireAk() {
            if (akAufgenommen == 1 && akSchuss.shots < 30) {
                akSchuss.fireAtPointer();
                munitionsText.text = munition - akSchuss.shots + ' Schuss übrig';
                if ((munition - akSchuss.shots) <= 0) {
                    munitionsText.text = '';
                    ausgeruesteterWaffenText.text = '';
                }
                waffeSchiessen();
            }
        }

        function firePistol() {
            if (pistoleAufgenommen == 1 && pistolenSchuss.shots < 12) {
                pistolenSchuss.fireAtPointer();
                munitionsText.text = munition - pistolenSchuss.shots + ' Schuss übrig';
                if ((munition - pistolenSchuss.shots) == 0) {
                    munitionsText.text = '';
                    ausgeruesteterWaffenText.text = '';
                }
                waffeSchiessen();
            }
        }

        function fireShotgun() {
            if (sgAufgenommen == 1 && shotgunSchuss.shots < 5) {
                shotgunSchuss.fireAtPointer();
                shotgunSchuss.fireAtPointer();
                shotgunSchuss.fireAtPointer();
                shotgunSchuss.fireAtPointer();
                shotgunSchuss.fireAtPointer();
                munitionsText.text = munition - shotgunSchuss.shots + ' Schuss übrig';
                if (munition - shotgunSchuss.shots == 0) {
                    munitionsText.text = '';
                    ausgeruesteterWaffenText.text = '';
                }
                waffeSchiessen();
            }
        }

        function fireRaketenwerfer() {
            if (rwAufgenommen == 1 && rakete.shots < 1) {
                rakete.fireAtPointer();
                munitionsText.text = munition - rakete.shots + ' Raketen übrig';
                if (munition - rakete.shots == 0) {
                    munitionsText.text = '';
                    ausgeruesteterWaffenText.text = '';
                }
                waffeSchiessenRaketenwerfer();
            }
        }

        function fireGw() {
            if (gwAufgenommen == 1) {}
        }
        // PISTOLE
        function schwachenGegnerMitPistoleTreffen(GegnerGruppe, pistolenSchuss) {
            pistolenSchuss.kill();
            // schwacherGegner.damage(1);
        }

        function starkenGegnermitPistoleTreffen(starkerGegner, pistolenSchuss) {
            pistolenSchuss.kill();
            // starkerGegner.damage(1);

        }
        // SHOTGUN
        function schwachenGegnerMitShotgunTreffen(schwacherGegner, shotgunSchuss) {
            // SchwacherGegner wird beim sofortigen Treffer getötet.
            // schwacherGegner.damage(0.5);
            // Die Kugel verschwindet nun.
            shotgunSchuss.kill();

        }

        function starkenGegnerMitShotgunTreffen(starkerGegner, shotgunSchuss) {
            // StarkerGegner wird beim sofortigen Treffer getötet.
            // starkerGegner.damage(0.5);
            // Die Kugel verschwindet nun.
            shotgunSchuss.kill();

        }
        // AK
        function schwachenGegnerMitAkTreffen(akSchuss, schwacherGegner) {
            // schwacherGegner wird beim sofortigen Treffer getötet.
            // schwacherGegner.damage(0.5);
            // Die Kugel verschwindet nun logischerweise.
            akSchuss.kill();

        }

        function starkenGegnerMitAkTreffen(akSchuss, starkerGegnerGruppe) {
            // starkerGegner.damage(0.5);
            akSchuss.kill();
        }
        // Schwacher wird beim sofortigen Treffer mit Raketenwerfer getötet.
        function schwachenGegnerMitRaketenwerferTreffen(schwacherGegner, raketenexplosion) {
            // schwacherGegner.kill();

        }
        // starkerGegner wird beim sofortigen Treffer mit Raketenwerfer getötet.
        function starkenGegnerMitRaketenwerferTreffen(starkerGegner, raketenexplosion) {
            // starkerGegner.kill();

        }
        // Win Funktion


        // WENN DIE ANZAHL DER GEGNEROBJEKTE NULL IST, DANN MESSAGE
        function youWin(gegner) {
            if (gegnerZahl == gegnerBesiegt) {
                let win = new Message('Gewonnen');
            }
        }

        function waffeSchiessen() {
            SchussPassiertjetzt = 1;
            game.physics.arcade.isPaused = false;
            game.time.events.add(Phaser.Timer.SECOND * 0.1, wiederStoppen, this);
        }

        function waffeSchiessenRaketenwerfer() {
            SchussPassiertjetzt = 1;
            game.physics.arcade.isPaused = false;
            game.time.events.add(Phaser.Timer.SECOND * 0.2, wiederStoppen, this);
        }

        function wiederStoppen() {
            SchussPassiertjetzt = 0;
            game.physics.arcade.isPaused = true;
        }

        function killSimpleProjectiles(einfacheProjektile, platforms) {
            einfacheProjektile.kill();
        }

        // Rakete erzeugt Raketenexplosion
        function raketeExplodiert(rakete, platforms) {
            raketenexplosion = game.add.sprite(rakete.x, rakete.y, 'explosion');
            raketenexplosion.anchor.setTo(0.5, 0.5);
            game.physics.arcade.enable(raketenexplosion);
            raketenexplosion.enableBody = true;
            rakete.kill();
            explosionTween = game.add.tween(raketenexplosion.scale);
            explosionTween.to({
                x: 3,
                y: 3
            }, 1000, Phaser.Easing.Linear.None, true);
        }
        // nimmt Shotgun auf
        function nimmSg(player, sg) {
            // Das Shotgun - Objekt wird gelöscht
            sg.kill();
            // Setzt andere Waffen auf null
            akAufgenommen = 0;
            rwAufgenommen = 0;
            pistoleAufgenommen = 0;
            // Der Spieler besitzt nun die Shotgun
            sgAufgenommen = 1;
            // Nur für Munitionsverwaltungwichtig.
            munition = 5;
            ausgeruesteterWaffenText.text = 'Shotgun ausgerüstet';
            munitionsText.text = munition + ' Schuss übrig';
        }
        // nimmt Pistole auf
        function nimmPistole(player, pistole) {
            pistole.kill();
            // Sezt andere Waffen auf null
            rwAufgenommen = 0;
            sgAufgenommen = 0;
            akAufgenommen = 0;
            // Pistole aufgenommen
            pistoleAufgenommen = 1;
            // 12 Schüsse
            munition = 12;
            ausgeruesteterWaffenText.text = 'Pistole ausgerüstet';
            munitionsText.text = munition + ' Schuss übrig';
        }
        // nimmt Raketenwerfer auf
        function nimmRw(player, rw) {
            rw.kill();
            // Setzt andere Waffen auf null
            sgAufgenommen = 0;
            akAufgenommen = 0;
            pistoleAufgenommen = 0;
            // Raketenwerferaufnehmen
            rwAufgenommen = 1;
            // 3 Raketen
            munition = 3;
            ausgeruesteterWaffenText.text = 'Raketenwerfer ausgerüstet';
            munitionsText.text = munition + ' Rakete übrig';
        }
        // nimmt AK auf
        function nimmak(player, ak) {
            ak.kill();
            // Setzt andere Waffen auf null
            rwAufgenommen = 0;
            sgAufgenommen = 0;
            pistoleAufgenommen = 0;
            // ak aufgenommen
            akAufgenommen = 1;
            // 6 Schüsse
            munition = 6;
            ausgeruesteterWaffenText.text = 'AK ausgerüstet';
            munitionsText.text = munition + ' Schuss übrig';
        }
        // Game Over Funktion
        function gameOver(player, alleGegner) {
            player.kill();
            let gameover = new Message('Game Over');
        }
    </script>

</body>

</html>